---
title: "jacaranda"
author: "berkeley_air_monitoring_group"
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0('mnch_results_',Sys.Date(),'.html'), output_dir = "Results") })

date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    self_contained: yes
---

# Analyze MNCH data
### Break out activity types from Errands only, to errands home vs. away?

```{r global_options, include=FALSE,echo = FALSE}

email = 0
timezone = 'GMT'
local_tz = 'Africa/Nairobi'
home_threshold_meters = 100 #meters
reimport = FALSE #Set to true if we have new GPS or PA data.


source('r_scripts/load.R')
source('r_scripts/plot_deployments.R')

dir.create("odk data",showWarnings = F)  #Put odk data downloads into here.
dir.create("Results/plots",showWarnings = F)
dir.create("Results/processed data",showWarnings = F)
dir.create("Results/QA Reports",showWarnings = F)
dir.create("Results",showWarnings = F)
dir.create("~/Dropbox/Jacaranda Kenya Field Folder/Data/Plots/HHs with Amb",showWarnings = F)
dir.create("~/Dropbox/Jacaranda Kenya Field Folder/Data/Plots/maps",showWarnings = F)
knitr::opts_chunk$set(fig.path='../Results/figures/', warning=FALSE, message=FALSE)

```


# Import GPS, PA, ODK data

```{r load_merge,cache=FALSE,echo = FALSE,include=FALSE}
source('r_scripts/import_odk.R')

if(reimport==TRUE){
  source('r_scripts/import_gps.R')
  source('r_scripts/import_purpleair.R')
}else{
  gps_data <- readRDS("Results/gps_data.RDS")
  pa_data <- readRDS("Results/processed data/pa_data.rds")
}


# Merge GPS, PA data.  PA data should already be merged with ODK data.
#Merge PA data with ODK data
# pa_data = merge(pa_data,meta_merged, by.x=c("hhid"), by.y = c("hhid"))

# as.data.frame(gps_data) %>%
#   dplyr::group_by(filename) %>%
#   dplyr::do(f=plotly_gps_files(.))

```

# Clean the ODK time activity and transport data, create time series of it.
```{r clean_odk,cache=TRUE,echo = FALSE,include=FALSE}


#Import and clean the odk transport data reviewed by Monica.
odkend_transport_processed_mm <- read_xlsx("~/Dropbox/Jacaranda Kenya/Data Analysis mnch/Results/processed data/odkend_transport_processed_mm_v2.xlsx") %>% 
  clean_names() %>% 
  dplyr::mutate(
    observed_time_in = as.numeric(observed_time_in),
    observed_time_out = as.numeric(observed_time_out),
    datetime_start_mod = case_when(is.na(observed_time_in) ~ datetime_end,
                                   TRUE ~ as.POSIXct(as.Date(datetime_end)) + 60*60*24*observed_time_in),
    datetime_end_mod =  case_when(is.na(observed_time_out) ~ datetime_start,
                                  TRUE ~ as.POSIXct(as.Date(datetime_start)) + 60*60*24*observed_time_out),
    dif =datetime_start_mod-datetime_end_mod
  )


#Create time series of the transport data so we can merge it with the PA data.
odkend_transport_tseries <- odkend_transport_processed_mm %>%
  dplyr::select(datetime_end_mod,datetime_start_mod,description,valid_flag,hhid) %>% 
  rowid_to_column() %>%
  gather(var, datetime, -description,-valid_flag,-hhid,-rowid) %>%
  distinct() %>%
  dplyr::group_by(rowid)  %>% 
  tidyr::complete(datetime=seq(min(datetime,na.rm=T), max(datetime,na.rm=T), by = "1 min")) %>% 
  fill(description,valid_flag,hhid) %>% 
  dplyr::ungroup() %>% 
  select(-var,-rowid) %>% 
  dplyr::rename(transportation = description)


odkend_time_activities <- read_xlsx("~/Dropbox/Jacaranda Kenya/Data Analysis mnch/Results/processed data/odkend_time_activities_processed_mm_7-7-21.xlsx") %>% 
  distinct() %>% 
  clean_names() %>% 
  dplyr::mutate(
    start = as.POSIXct(start,tz = local_tz),
    end = as.POSIXct(end,tz = local_tz),
    datetime_start = case_when(is.na(start) ~ datetime_start,
                               datetime_start != start ~ start,
                               TRUE ~ datetime_start),
    datetime_end =  case_when(is.na(end) ~ datetime_end,
                              datetime_end != end ~ end,
                              TRUE ~ datetime_end),
    dif = datetime_start-datetime_end
  ) %>% 
  #No longer needed, as we have the full clean set corrected.#Import the full clean set.  Merge with the corrected one
  # odkend_time_activities = read_rds('Results/processed data/odkend_time_activities_processed.RDS') %>% 
  # dplyr::left_join(odkend_time_activities_mm) #%>% #Newer version.
  # dplyr::left_join(read_xlsx("~/Dropbox/Jacaranda Kenya/Data Analysis mnch/Results/processed data/odkend_time_activities_processed_mm.xlsx") #%>% #Old version
  # dplyr::select(-description),
  # by = c("KEY","survey_datetime_end","hhid","description")
  dplyr::select(-notes,-survey_datetime_end,-accurately_reported) %>% 
  dplyr::rename(activity = description) %>% 
  dplyr::mutate(activity_clean = 
                  case_when(activity %like% "Cyber|cyber|Repair|Visit|visit|teacher|friend|Greet|neighbo|relative" ~ "Errands_out",
                            activity %like% "walk|Walk|Shopping|neighborhood|Fetch|Chamas|bank|Bank|Pay_rent" ~ "Errands_out",
                            activity %like% "Sleeping|None|Did_not|Resting|House|taking_food" ~ "Errands_home",
                            activity %like% "child|baby|taker|medicine|Chores" ~ "Childcare",
                            activity %like% "Posho|report|Meeting|Gh" ~ "Errands_out",
                            TRUE ~ activity),
                activity_clean_source = paste0(activity_clean,"_",smoke_sources),
                activity_clean_source = gsub("_NA","",activity_clean_source))

odkend_activities_tseries <- odkend_time_activities %>%
  dplyr::select(datetime_end,datetime_start,activity_clean,hhid,activity_clean_source,smoke_sources) %>% 
  rowid_to_column() %>%
  gather(var, datetime, -activity_clean,-hhid,-rowid,-activity_clean_source,-smoke_sources) %>%
  distinct() %>%
  dplyr::group_by(rowid)  %>% 
  tidyr::complete(datetime=seq(min(datetime,na.rm=T), max(datetime,na.rm=T), by = "1 min")) %>% 
  fill(activity_clean,activity_clean_source,smoke_sources,hhid) %>% 
  dplyr::ungroup() %>% 
  select(-var,-rowid) 

odkend_time_activities_wide <-  odkend_time_activities %>% 
  dplyr::group_by(activity_clean, hhid) %>% 
  dplyr::summarise(time_hours = sum(difftime(datetime_end,datetime_start,units="hours"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(time_hours = if_else(as.numeric(time_hours)<0,0,as.numeric(time_hours))) %>% 
  tidyr::pivot_wider(names_from = c("activity_clean"),values_from = "time_hours")

odkend_time_activities_wide_sources <-  odkend_time_activities %>% 
  dplyr::group_by(smoke_sources, hhid) %>% 
  dplyr::summarise(time_hours = sum(difftime(datetime_end,datetime_start,units="hours"))) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(time_hours = if_else(as.numeric(time_hours)<0,0,as.numeric(time_hours))) %>% 
  tidyr::pivot_wider(names_from = c("smoke_sources"),values_from = "time_hours")

odk_activity_transpo_tseries <- odkend_activities_tseries %>% 
  dplyr::full_join(odkend_transport_tseries, by = c("hhid","datetime")) %>% 
  dplyr::rename(local_time = datetime,
                valid_activity = valid_flag)

```

# Merge the PA, GPS, ODK data.
```{r merge_all,cache=TRUE,echo = FALSE}


#Distance calculation constants
R = 6371e3 #meters - radius of earth
phi_fun = function(lat) {lat*pi/180}
phi_delta = function(lat1,lat2) {(lat1-lat2)*pi/180}
lambda_delta_fun = function(lon1,lon2) {(lon2-lon1)*pi/180}
x_fun = function(lambda_delta,phi){lambda_delta*cos(phi)}

#Merge data and clean it up.  
#Flag PA data if less than 18 hours.
all_merged = merge(pa_data, #data every other minute
                   gps_data, #data every minute.  Comes out to every other minute for the merged set.
                   by=c('local_time','hhid'),all.x = TRUE,all.y = FALSE) %>% 
  dplyr::mutate(hhid = gsub("AMBIENT","Ambient",hhid),
                pa_file = basename(filename.x),
                gps_file = basename(filename.y),
                sampletype = ifelse(tolower(pa_file) %like% 'amb','ambient','personal'),
                gps_filled = ifelse(is.na(lat),1,0)) %>% 
  dplyr::rename(pa_id = instrument_id.x,
                gps_id = instrument_id.y) %>% 
  dplyr::filter(!filename.x %like% "Pilot") %>%
  dplyr::filter(!is.na(local_time),!is.infinite(local_time)) %>% 
  # Fill in time series down for GPS - seems appropriate for most cases based on time series plot of gps data.
  dplyr::group_by(sampletype, hhid) %>%
  fill(lat, .direction = "down") %>% 
  fill(lon, .direction = "down") %>% 
  dplyr::mutate(N = n(),
                Mode_lat = median(lat,na.rm = T),
                Mode_lon = median(lon,na.rm = T),
                phi = phi_fun(lat),
                lambda_delta = lambda_delta_fun(lon,Mode_lon),
                x = x_fun(lambda_delta,phi),
                y = phi_delta(lat,Mode_lat),
                d_meters = R * sqrt(x^2 + y^2),
                home_flag = ifelse(d_meters < home_threshold_meters,1,0),
                valid_pa = if_else(N<1080/2,0,1), #valid is 1, invalid is 0.  Corresponds to 18 hours
                region = case_when(filename.x %like% "Dagoretti" ~ "Dagoretti",
                                   TRUE ~ "Starehe"),
                exposure_category = case_when(pm25_bam_ave <= 10 ~ "Exposure<10",
                                              pm25_bam_ave > 10 & pm25_bam_ave < 35 ~ "10<Exposure<35",
                                              pm25_bam_ave > 35 & pm25_bam_ave < 100 ~ "Exposure>35",
                                              TRUE ~ "Exposure>100"),
                exposure_category = factor(exposure_category,
                                           levels = c("Exposure<10","10<Exposure<35","Exposure>35","Exposure>100")))%>%
  dplyr::ungroup() %>% 
  dplyr::select(-lambda_delta,-phi,-x,-y,filesize_kb,-filename.y) %>% 
  dplyr::left_join(odkstart %>% 
                     dplyr::select(BAmbientStartB2location,hhid,BAmbientStartB1gpsLatitude,
                                   BAmbientStartB1gpsLongitude,BAmbientStartB4PurpleAirID) %>% 
                     dplyr::rename(pa_id = BAmbientStartB4PurpleAirID,
                                   hhid_ambient = hhid),
                   by = "pa_id") %>% 
  dplyr::mutate(hhid_ambient = paste0(hhid_ambient,"_",as.Date(local_time)),
                hhid = case_when(sampletype == "ambient" & !is.na(BAmbientStartB2location) ~ hhid_ambient,
                                 TRUE ~ hhid),
                lat = case_when(sampletype == "ambient" & !is.na(BAmbientStartB2location) ~ BAmbientStartB1gpsLatitude,
                                TRUE ~ lat),
                lon = case_when(sampletype == "ambient" & !is.na(BAmbientStartB2location) ~ BAmbientStartB1gpsLongitude,
                                TRUE ~ lon),
                region = case_when(hhid %like% "Dagoretti|Kabiro" ~ "Dagoretti",
                                   hhid %like% "Kiboro|Kiamiako" ~ "Starehe",
                                   TRUE ~ region)) %>% 
  dplyr::group_by(sampletype, hhid) %>%
  dplyr::mutate(N = n(),
                valid_pa = if_else(N<1080/2,0,1)) %>%  #valid is 1, invalid is 0.  Corresponds to 18 hours
  dplyr::filter(valid_pa == 1) %>% 
  dplyr::ungroup()



skimr::skim(all_merged)

# View(all_merged %>% dplyr::filter(hhid %like% "Ambient"))
# View(all_merged %>% dplyr::filter(pa_id %like% "11"))

```



# Summarize data
* Calculate distance metric from home (mode)
* What fraction of exposure happens at home?
* Get list of home GPSs, calculate fraction of exposure near there.

```{r summarize_data,echo = FALSE}

summary_pa_deployment <- all_merged %>% 
  dplyr::group_by(sampletype, hhid,region) %>%
  dplyr::summarise(N_gps_samples = sum(!is.na(lat)), 
                   N_pa_samples = sum(!is.na(pm25_bam_ave)),
                   N_hours = difftime(max(local_time,na.rm = T),
                                      min(local_time,na.rm = T),units = "hours"),
                   Min_pm25 = min(pm25_bam_ave,na.rm = TRUE), 
                   Median_pm25 = median(pm25_bam_ave,na.rm = TRUE),
                   Mean_pm25 = mean(pm25_bam_ave,na.rm = TRUE), 
                   Max_pm25 = max(pm25_bam_ave,na.rm = TRUE),
                   SD_pm25 = sd(pm25_bam_ave,na.rm = TRUE),
                   Mode_lat = median(lat,na.rm = T), 
                   Mode_lon = median(lon,na.rm = T),
                   n_home = sum(home_flag == 1,na.rm = T),
                   n_away = sum(home_flag == 0,na.rm = T),
                   home_fraction = n_home/(n_home+n_away),
                   Mean_home_pm25 = mean(pm25_bam_ave[home_flag==1],na.rm = TRUE),
                   Mean_away_pm25 = mean(pm25_bam_ave[home_flag==0],na.rm = TRUE)) %>%
  dplyr::left_join(
    all_merged %>% 
      dplyr::select(pa_file,gps_file,pa_id,gps_id,hhid) %>% 
      dplyr::distinct() %>% 
      dplyr::arrange(pa_file,gps_file) %>% 
      dplyr::group_by(hhid) %>% 
      dplyr::filter(1 == row_number()),
    by = "hhid")
DT::datatable(summary_pa_deployment, caption = "PurpleAir Summary Table")

summary_overall <- summary_pa_deployment %>% 
  dplyr::group_by(sampletype,region) %>%
  dplyr::summarise(N = n(), 
                   N_greater_WHO_35 = sum(Mean_pm25>35,na.rm = TRUE),
                   Min_pm25 = min(Min_pm25,na.rm = TRUE), 
                   Median_pm25 = median(Median_pm25,na.rm = TRUE),
                   Mean_pm25 = mean(Mean_pm25,na.rm = TRUE), 
                   Max_pm25 = max(Max_pm25,na.rm = TRUE),
                   SD_pm25 = sd(SD_pm25,na.rm = TRUE),
                   Mean_home_pm25 = mean(Mean_home_pm25,na.rm = TRUE),
                   Mean_away_pm25 = mean(Mean_away_pm25,na.rm = TRUE))
kable(summary_overall, caption = "PurpleAir Overall Summary Table by District","pipe",digits = 1)

summary_overall_overall <- summary_pa_deployment %>% 
  dplyr::group_by(sampletype) %>%
  dplyr::summarise(N = n(), 
                   N_greater_WHO_35 = sum(Mean_pm25>35,na.rm = TRUE),
                   Min_pm25 = min(Min_pm25,na.rm = TRUE), 
                   Median_pm25 = median(Median_pm25,na.rm = TRUE),
                   Mean_pm25 = mean(Mean_pm25,na.rm = TRUE), 
                   Max_pm25 = max(Max_pm25,na.rm = TRUE),
                   SD_pm25 = sd(SD_pm25,na.rm = TRUE),
                   Mean_home_pm25 = mean(Mean_home_pm25,na.rm = TRUE),
                   Mean_away_pm25 = mean(Mean_away_pm25,na.rm = TRUE))
kable(summary_overall_overall, caption = "PurpleAir Overall Summary Table","pipe",digits = 1)


```




# Exposure boxplots
* Plot boxplots and scatter plots for exposures, HAP, ratios therein.
* Save html maps.

```{r boxplots_usage, fig.width=7, fig.height=4,echo = FALSE}

#Plot each deployment's raw time series data
as.data.frame(all_merged) %>%
  dplyr::group_by(filename.x) %>%
  dplyr::do(f=plot_pa_with_gps(.))

#Box plots for home vs. away from home.
g_boxplot_distance <- summary_pa_deployment %>% 
  pivot_longer(cols = c("Mean_home_pm25","Mean_away_pm25")) %>% 
  ggplot(aes(x=name, y = value, colour = name)) +
  facet_grid(.~region) + 
  geom_boxplot(alpha = 0.25,outlier.shape = NA) +
  stat_summary(fun.y=mean, colour="blue", geom="point",
               shape=18, size=4.5,alpha = 0.5)+
  stat_summary(fun.data = give.mean10, geom = "text",colour="blue") +
  geom_jitter(height = 0,width = 0.2,alpha = 0.25) +
  stat_summary(fun.data = give.n, geom = "text") +
  labs(y="Mean PM2.5 Concentration (ugm-3)",x="") +
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())
g_boxplot_distance


g_boxplot <- ggplot(summary_pa_deployment,aes(x=sampletype, y = Mean_pm25)) +
  geom_boxplot(alpha = 0.25,outlier.shape = NA) +
  stat_summary(fun.y=mean, colour="blue", geom="point",
               shape=18, size=4.5,alpha = 0.5)+
  stat_summary(fun.data = give.mean10, geom = "text",colour="blue") +
  geom_jitter(height = 0,width = 0.2,alpha = 0.25) +
  facet_grid(.~region) + 
  stat_summary(fun.data = give.n, geom = "text") +
  labs(y="Mean PM2.5 Concentration (ugm-3)",x="") +
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())
g_boxplot

summary_wide <- tidyr::pivot_wider(summary_pa_deployment,
                                   id_cols = c('hhid','sampletype'),
                                   names_from = sampletype ,
                                   values_from = c('Mean_pm25','N_gps_samples'))


summary_by_activity_temp <- all_merged %>% 
  dplyr::left_join(odk_activity_transpo_tseries) %>% 
  dplyr::mutate(activity_clean = if_else(is.na(activity_clean),"None",activity_clean),
                transportation = if_else(is.na(transportation),"None",transportation)) %>% 
  dplyr::filter(!hhid == "Ambient") %>% 
  dplyr::mutate(activity_clean = 
                  case_when(is.na(activity_clean) ~ "Errands_home",
                            activity_clean %like% "Childcare" ~ "Childcare",
                            activity_clean %like% "Working|Errands|Shopping|Bank|Visiting|Errands_out" ~ "Errands_out",
                            activity_clean %like% "Chores|Childcare|Resting|Sleeping|Errands_home" ~ "Errands_home",
                            activity_clean %like% "None" ~ "Errands_home",
                            TRUE ~ activity_clean),
                activity_clean = 
                  factor(activity_clean,
                         levels = c("Errands_home","Errands_out","LPG_stove","Wood_stove", "Charcoal_stove",  
                                    "Kerosene_stove","Cooking", "Incense", "Mosquito_coil", 
                                    "Chores","Working","Shopping","Bank","Childcare","Resting",
                                    "Visiting","Sleeping","None","Other")))
# add_count(activity_clean) %>%
# mutate(activity_clean = if_else(n < 3, "other", activity_clean)) %>%
# count(activity_clean) %>% 

summary_by_activity <- summary_by_activity_temp %>% 
  dplyr::group_by(sampletype, hhid,activity_clean,region) %>% 
  dplyr::summarise(N = n(), 
                   Min_pm25 = min(pm25_bam_ave,na.rm = TRUE), 
                   Median_pm25 = median(pm25_bam_ave,na.rm = TRUE),
                   Mean_pm25 = mean(pm25_bam_ave,na.rm = TRUE), 
                   dose_pm25_ug = mean(pm25_bam_ave,na.rm = TRUE)*N*2*0.006, # 6 liters per minute = 0.006m^3/minute
                   Max_pm25 = max(pm25_bam_ave,na.rm = TRUE),
                   SD_pm25 = sd(pm25_bam_ave,na.rm = TRUE))  

DT::datatable(summary_by_activity, caption = "PurpleAir Summary Table by Activity")

g_activity_boxplot <- ggplot(summary_by_activity,aes(x=activity_clean, y = Mean_pm25)) +
  geom_boxplot(alpha = 0.25,outlier.shape = NA) +
  stat_summary(fun.y=mean, colour="blue", geom="point",
               shape=18, size=4.5,alpha = 0.5)+
  stat_summary(fun.data = give.mean10, geom = "text",colour="blue") +
  geom_jitter(height = 0,width = 0.2,alpha = 0.25) +
  stat_summary(fun.data = give.n, geom = "text") +
  labs(y="Mean PM2.5 Concentration (ugm-3)",x="") +
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())
g_activity_boxplot

g_activity_boxplot_district <- g_activity_boxplot +
    facet_grid(.~region) 
g_activity_boxplot_district

summary_by_activity_source <- summary_by_activity_temp %>% 
  dplyr::group_by(sampletype, hhid,smoke_sources,region) %>% 
  dplyr::summarise(N = n(), 
                   Min_pm25 = min(pm25_bam_ave,na.rm = TRUE), 
                   Median_pm25 = median(pm25_bam_ave,na.rm = TRUE),
                   Mean_pm25 = mean(pm25_bam_ave,na.rm = TRUE), 
                   dose_pm25_ug = mean(pm25_bam_ave,na.rm = TRUE)*N*2*0.006, # 6 liters per minute = 0.006m^3/minute
                   Max_pm25 = max(pm25_bam_ave,na.rm = TRUE),
                   SD_pm25 = sd(pm25_bam_ave,na.rm = TRUE))  

g_activity_boxplot_sources <- ggplot(summary_by_activity_source,aes(x=smoke_sources, y = Mean_pm25)) +
  geom_boxplot(alpha = 0.25,outlier.shape = NA) +
  stat_summary(fun.y=mean, colour="blue", geom="point",
               shape=18, size=4.5,alpha = 0.5)+
  stat_summary(fun.data = give.mean10, geom = "text",colour="blue") +
  geom_jitter(height = 0,width = 0.2,alpha = 0.25) +
  # facet_grid(.~region) + 
  stat_summary(fun.data = give.n, geom = "text") +
  labs(y="Mean PM2.5 Concentration (ugm-3)",x="") +
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())+
  ggtitle("Sources participants smelled during activities")
g_activity_boxplot_sources

# Doesn't make a whole lot of sense. 
# g_activity_bars_conc <- summary_by_activity %>% 
#   dplyr::group_by(activity_clean) %>% 
#   dplyr::arrange(Mean_pm25) %>% 
#   dplyr::ungroup() %>% 
#   ggplot(aes(x = hhid,fill=activity_clean, y = Mean_pm25)) +
#   geom_bar(position="fill", stat="identity") + 
#   labs(y="Percent of exposure by concentration (µg/m3)",x="") +
#   scale_x_discrete(labels = NULL, breaks = NULL)
# g_activity_bars_conc

g_activity_bars_dose <- summary_by_activity %>% 
  dplyr::group_by(activity_clean) %>% 
  dplyr::arrange(dose_pm25_ug) %>% 
  dplyr::ungroup() %>% 
  ggplot(aes(fct_reorder(hhid,dose_pm25_ug),fill=activity_clean, y = dose_pm25_ug)) +
  geom_bar(position="fill", stat="identity") + 
  facet_grid(.~region,scales="free") + 
  labs(y="Percent of dose",x="") +
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  scale_x_discrete(labels = NULL, breaks = NULL)
g_activity_bars_dose

summary_by_transport <- all_merged %>% 
  dplyr::left_join(odk_activity_transpo_tseries) %>% 
  dplyr::mutate(activity_clean = if_else(is.na(activity_clean),"None",activity_clean),
                transportation = if_else(is.na(transportation),"None",transportation)) %>% 
  dplyr::filter(!hhid == "Ambient") %>% 
  dplyr::group_by(sampletype, hhid,transportation) %>% 
  dplyr::summarise(N = n(), 
                   Min_pm25 = min(pm25_bam_ave,na.rm = TRUE), 
                   Median_pm25 = median(pm25_bam_ave,na.rm = TRUE),
                   Mean_pm25 = mean(pm25_bam_ave,na.rm = TRUE), 
                   Max_pm25 = max(pm25_bam_ave,na.rm = TRUE),
                   SD_pm25 = sd(pm25_bam_ave,na.rm = TRUE))
DT::datatable(summary_by_transport, caption = "PurpleAir Summary Table by Transportation")

g_transport_boxplot <- ggplot(summary_by_transport,aes(x=transportation, y = Mean_pm25)) +
  geom_boxplot(alpha = 0.25,outlier.shape = NA) +
  stat_summary(fun.y=mean, colour="blue", geom="point",
               shape=18, size=4.5,alpha = 0.5)+
  stat_summary(fun.data = give.mean10, geom = "text",colour="blue") +
  geom_jitter(height = 0,width = 0.2,alpha = 0.25) +
  stat_summary(fun.data = give.n, geom = "text") +
  labs(y="Mean PM2.5 Concentration (ugm-3)",x="") +
  ylim(0,100) + 
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())
g_transport_boxplot


# Time of day plot
g_timeofday_pa <- all_merged %>% 
  dplyr::mutate(time_of_daystr = strftime(local_time, format="%H:%M:%S",tz = local_tz),
                time_of_day = as.POSIXct(time_of_daystr, format="%H:%M:%S",tz = local_tz))  %>% 
  ggplot(aes(x=time_of_day, y = pm25_bam_ave,color = sampletype,shape = as.factor(home_flag))) +
  geom_smooth(alpha = 0.25) +
  # facet_grid(sampletype~.) + 
  labs(y="PM2.5 Concentration (ugm-3)",x="Households") +
  scale_x_datetime(date_breaks = "3 hours",date_labels = "%H:%M") +
  theme(legend.title = element_blank()) + 
  geom_hline(aes(yintercept=10)) +
  facet_grid(region~.) + 
  ylim(0,75)+
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  geom_text(aes(min(time_of_day),15,label = "WHO Guideline (10 µg/m3)",hjust = 0)) +
  geom_hline(aes(yintercept=35)) +
  geom_text(aes(min(time_of_day),40,label = "WHO Interim-1 Target (35 µg/m3)",hjust = 0))
g_timeofday_pa

#Plot stacked bar plots of exposures by individual

g_categories_bars_exposure <- all_merged %>% 
  ggplot(aes(x = hhid,fill=exposure_category, y = pm25_bam_ave)) +
  geom_bar(position="fill", stat="identity") + 
  labs(y="Exposure category",x="Households") +
  scale_x_discrete(labels = NULL, breaks = NULL)
g_categories_bars_exposure

#Plot stacked bar plots by time of day
g_categories_bars_exposure <- all_merged %>% 
  dplyr::mutate(time_of_daystr = strftime(local_time, format="%H:%M:%S",tz = local_tz),
                time_of_day = with_tz(as.POSIXct(time_of_daystr, format="%H",tz = "UTC"),local_tz))  %>% 
  dplyr::group_by(time_of_day) %>% 
  dplyr::mutate(N = n()) %>% 
  ggplot(aes(x = time_of_day,fill=exposure_category, y = N)) +
  geom_bar(position="fill", stat="identity") + 
  labs(y="Fraction of samples",x="") +
  scale_x_datetime(date_breaks = "3 hours",labels = date_format("%H:%M")) +
  ggtitle("Fraction of samples by exposure category, by hour")
g_categories_bars_exposure

```


###Spatial Results
# Geo-spatial analysis
* Hot spots
```{r spatial_usage, fig.width=7, fig.height=4}

# # mapbase <- get_googlemap(center = c(mean(summary_pa_deployment$Mode_lon),mean(summary_pa_deployment$Mode_lat)), zoom = 12,
# #                          color = "color",
# #                          style = "feature:road|visibility:on&style=element:labels|visibility:on&style=feature:administrative|visibility:on")
# # #Map showing average exposure and median location. Different shape by sample type.
# # gg_ave <- ggmap(mapbase) +
# #   geom_point(data = summary_pa_deployment, aes(x = Mode_lon, y = Mode_lat, color=Mean,shape =sampletype))+
# #   scale_size_continuous(breaks = round) 
# # gg_ave <- ggplotly(gg_ave)

pal <- colorNumeric(
  palette = colorRampPalette(c('green', 'yellow','red'))(20),
  domain = c(0,100))

gg_ave <- leaflet() %>%
  addTiles() %>%  # use the default base map which is OpenStreetMap tiles
  # addProviderTiles(providers$Esri.WorldImagery) %>% #Test this baby out.
  addScaleBar(position = c("topright", "bottomright", "bottomleft", "topleft"),
              options = scaleBarOptions(maxWidth = 100,
                                        metric = TRUE,
                                        imperial = TRUE,
                                        updateWhenIdle = TRUE)) %>% 
  addCircleMarkers(lng=summary_pa_deployment$Mode_lon, lat=summary_pa_deployment$Mode_lat,
                   popup=paste(summary_pa_deployment$hhid,', ',summary_pa_deployment$sampletype,', ', summary_pa_deployment$Mean_pm25),
                   # fillColor = all_merged$pm25_bam_ave
                   radius =  (summary_pa_deployment$Mean_pm25+10)/10,
                   color = pal(summary_pa_deployment$Mean_pm25))

saveWidget(gg_ave, '~/Dropbox/Jacaranda Kenya Field Folder/Data/Plots/maps/ave_map_jacaranda.html', selfcontained = T)

#Map with point per average deployment.


map_by_filedeployment <- function(all_merged,pal) {
  
  plot_name = paste0("~/Dropbox/Jacaranda Kenya Field Folder/Data/Plots/maps/map_",all_merged$hhid[1],".html")
  # if(!file.exists(plot_name)){
  
  gg <- leaflet() %>%
    addTiles() %>%  # use the default base map which is OpenStreetMap tiles
    addScaleBar(position = c("topright", "bottomright", "bottomleft", "topleft"),
                options = scaleBarOptions(maxWidth = 100,
                                          metric = TRUE,
                                          imperial = TRUE,
                                          updateWhenIdle = TRUE)) %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% #Test this baby out.
    addCircles(lng=all_merged$lon,
               lat=all_merged$lat,
               popup=paste(all_merged$local_time,', ',
                           all_merged$hhid,', ',
                           round(all_merged$d_meters,1),'m from home, ', 
                           round(all_merged$pm25_bam_ave,1),'µg/m^3'),
               fillColor = pal(all_merged$pm25_bam_ave),
               # radius =  (all_merged$pm25_bam_ave+10)/10,
               color = pal(all_merged$pm25_bam_ave)
    ) %>% 
    addCircles(lng=median(all_merged$lon,na.rm = T),
               lat=median(all_merged$lat,na.rm = T),
               popup=paste("Home/mode: ",all_merged$local_time,', ',
                           all_merged$hhid,', ',all_merged$sampletype,', ', all_merged$pm25_bam_ave),
               fillColor = "black",
               # radius =  (all_merged$pm25_bam_ave+10)/10,
               color = "black"
    )
  saveWidget(gg, plot_name, selfcontained = T)
  # }
}

#Map for each deployment
#.001 degrees ~ 111m, .0001 degrees ~ 11.1m
all_merged %>%
  dplyr::left_join(odk_activity_transpo_tseries) %>% 
  dplyr::mutate(activity_clean = if_else(is.na(activity_clean),"None",activity_clean),
                transportation = if_else(is.na(transportation),"None",transportation)) %>% 
  dplyr::group_by(hhid) %>%
  dplyr::do(a=map_by_filedeployment(.,pal))

#Map for all deployments together.  It's kind of a clusterfuck:
all_merged %>%
  dplyr::mutate(hhid = "all") %>% 
  dplyr::do(a=map_by_filedeployment(.,pal))

#Do an average by grid cell.
all_merged_geoave <- all_merged %>%
  mutate(lon.group = cut(lon, breaks = seq(floor(min(all_merged$lon,na.rm=T)), ceiling(max(all_merged$lon,na.rm=T)), by = .001),
                         labels = seq(floor(min(all_merged$lon,na.rm=T)) + .0005, ceiling(max(all_merged$lon,na.rm=T)), by = .001)),
         lat.group = cut(lat, breaks = seq(floor(min(all_merged$lat,na.rm=T)), ceiling(max(all_merged$lat,na.rm=T)), by = 1e-3),
                         labels = seq(floor(min(all_merged$lat,na.rm=T)) + 1e-3, ceiling(max(all_merged$lat,na.rm=T)), by = 1e-3))) %>%
  group_by(lon.group, lat.group) %>%
  summarise(pm25_bam_geoave = mean(pm25_bam_ave), 
            pm25_bam_sd = sd(pm25_bam_ave,na.rm=T), .groups = "drop") %>%
  mutate(across(where(is.factor), ~as.numeric(as.character(.x))),
         pm25_bam_sd = ifelse(is.na(pm25_bam_sd),10,pm25_bam_sd))

pal2 <- colorNumeric(
  palette = colorRampPalette(c('green', 'yellow','red'))(20),
  domain = c(0,100))

plot_name = paste0("~/Dropbox/Jacaranda Kenya Field Folder/Data/Plots/maps/map_grid_ave.html")

gg <- leaflet() %>%
  addTiles() %>%  # use the default base map which is OpenStreetMap tiles
  addProviderTiles(providers$Esri.WorldImagery) %>% #Test this baby out.
  addScaleBar(position = c("topright", "bottomright", "bottomleft", "topleft"),
              options = scaleBarOptions(maxWidth = 100,
                                        metric = TRUE,
                                        imperial = TRUE,
                                        updateWhenIdle = TRUE)) %>% 
  addCircles(lng=all_merged_geoave$lon.group,
             lat=all_merged_geoave$lat.group,
             popup=paste0("pm2.5: ",round(all_merged_geoave$pm25_bam_geoave,1),"µg/m3"),
             fillColor = pal2(all_merged_geoave$pm25_bam_geoave),
             radius =  (all_merged_geoave$pm25_bam_sd+100)/10,
             color = pal2(all_merged_geoave$pm25_bam_geoave)
  )
saveWidget(gg, plot_name, selfcontained = T)

plot_name = paste0("~/Dropbox/Jacaranda Kenya Field Folder/Data/Plots/maps/map_grid_ave_streets.html")

gg <- leaflet() %>%
  addTiles() %>%  # use the default base map which is OpenStreetMap tiles
  addScaleBar(position = c("topright", "bottomright", "bottomleft", "topleft"),
              options = scaleBarOptions(maxWidth = 100,
                                        metric = TRUE,
                                        imperial = TRUE,
                                        updateWhenIdle = TRUE)) %>% 
  addCircles(lng=all_merged_geoave$lon.group,
             lat=all_merged_geoave$lat.group,
             popup=paste0("pm2.5: ",round(all_merged_geoave$pm25_bam_geoave,1),"µg/m3"),
             fillColor = pal2(all_merged_geoave$pm25_bam_geoave),
             radius =  (all_merged_geoave$pm25_bam_sd+100)/10,
             color = pal2(all_merged_geoave$pm25_bam_geoave)
  )
saveWidget(gg, plot_name, selfcontained = T)


```



# Ambient plots
```{r ambient_plots}

#Different plot for each household # 
# pa_data_temp <- all_merged %>% dplyr::filter(!hhid %like% "AMBIENT") 

#Plot each hhid
pa_ambient = all_merged %>% dplyr::filter(hhid %like% "Ambient")

all_merged %>% 
  dplyr::filter(!hhid %like% "Ambient") %>% 
  dplyr::group_by(hhid) %>%
  dplyr::do(f = plot_by_filedeployment(.,pa_ambient))

#Map for all deployments together.  It's kind of a clusterfuck:
pa_ambient %>%
  dplyr::do(a=map_by_filedeployment(.,pal))



g_boxplot <- ggplot(pa_ambient,aes(x=hhid, y = pm25_bam_ave)) +
  geom_boxplot(alpha = 0.25,outlier.shape = NA) +
  geom_jitter(height = 0,width = 0.05,alpha = 0.01) +
  facet_grid(.~region,scales="free") + 
  ylim(0,100) + 
  stat_summary(fun.data = give.n, geom = "text") +
  labs(y="Mean PM2.5 Concentration (ugm-3)",x="") +
  stat_summary(fun.y=mean, colour="blue", geom="point",
               shape=18, size=4.5,alpha = 0.85)+
  stat_summary(fun.data = give.mean10, geom = "text",colour="blue") +
  theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())
g_boxplot

g_boxplot <- ggplot(pa_ambient,aes(x=local_time, y = pm25_bam_ave,color = hhid)) +
  geom_line(alpha = 0.5) +
  facet_grid(region~.) +
  labs(y="PM2.5 Concentration (ugm-3)",x="") +
  # theme(axis.text.x=element_text(angle=45,hjust= 1 ,vjust = 1)) +
  theme(legend.title = element_blank())
g_boxplot

```



# Generate models
```{r models}

#######Prepare the data for modeling
#1 Exposure ~ odkend survey
modeldata <- summary_pa_deployment %>% 
  dplyr::filter(!hhid %like% "Ambient") %>%
  dplyr::left_join(odkend %>% 
                     dplyr::filter(!`Surveyend-Surveyendnotes` %like% "Ghh") %>% 
                     dplyr::select(hhid,ends_with("yn"),contains("smoking"),
                                   contains("cook"),contains("lightingtype")),
                   by ="hhid") %>% 
  dplyr::left_join(odkend_time_activities_wide,by = "hhid") %>% #This adds hours of activity times
  dplyr::ungroup() %>% 
  dplyr::select(-sampletype,-N_gps_samples,-N_pa_samples,N_hours,-Min_pm25,
                -Median_pm25,-Max_pm25,-SD_pm25,-Mode_lat,-Mode_lon) %>% 
  dplyr::rename(insidecooking = `D_followupquestions2-D5_insideoutsidecooking`,
                tobacco_exp_freq = `D_followupquestions2-D7_cookinhaledtobaccofrequency`,
                tobacco_freq = `D_followupquestions2-D6_cooksmokingfrequency`,
                mosquitocoilyn = `I_mosquitocoil-I1_mosquitocoilyn`,
                firewoodyn = `E_firewoodstove-E1_firewoodyn`,
                charcoalyn = `F_charcoalstove-F1_charcoalyn`,
                keroseneyn = `L_kerosenestove-L1_keroseneyn`,
                gasetheleyn = `G_gasethele-G1_gasetheleyn`,
                mosquitocoilyn = `I_mosquitocoil-I1_mosquitocoilyn`,
                incensecoilyn = `M_incense-M1_incensecoilyn`) %>% 
  dplyr::mutate(insidecooking = fct_recode(insidecooking, 
                                           "inside" = "1",
                                           "outside" = "0")) %>% 
  dplyr::filter(!is.na(insidecooking)) %>% 
  mutate_if(is.numeric, ~replace(., is.na(.), 0))





#######Explore the yn data and model it.
# A regression model was applied between the 24-hr average exposures and the survey responses indicating whether people used different types of stoves, used mosquito coils, whether they cooked inside or outside, what fraction of the time they were at home (per GPS data), and how many times they were exposed to tobacco smoke during the sampling period.  The use of charcoal and mosquito coils significant predictors of increased exposure (14.7 µg/m3 and 30.1 µg/m3; p < 0.05), and the frequency of tobacco exposure is associated with a 2.9 µg/m3 increase per instance of exposure (p = 0.06).  Use of gas or electric cooking is a significant predictor of lower exposure vs. not using gas or electric cooking (p < 0.05)
modeldata_yn <- modeldata %>%  dplyr::select(Mean_pm25,insidecooking ,tobacco_exp_freq,#tobacco_freq,
                                             mosquitocoilyn ,firewoodyn ,charcoalyn ,keroseneyn ,
                                             gasetheleyn ,mosquitocoilyn, region,
                                             incensecoilyn,home_fraction,D8_lightingtype)

scatterplots <- ggpairs(modeldata_yn)
# print(scatterplots)
# corrplots <- ggcorr(modeldata_yn)
# print(corrplots)

#Could add number of cooking events explicitly here, or hours of different activities.
#Cooking event number would be to sum hours by hhid, by stove type, from the activity data.
fit <- lm(Mean_pm25 ~tobacco_exp_freq + 
            insidecooking+
            
            # tobacco_freq + 
            # region+
            home_fraction+
            gasetheleyn+
            firewoodyn +
            charcoalyn+
            keroseneyn +
            mosquitocoilyn,
          # Charcoal_stove+#D8_lightingtype
          # Errands_home+
          # Errands_out
          # Kerosene_stove+LPG_stove+#Mosquito_coil+       Incense
          # Wood_stove
          # incensecoilyn# +
          # D8_lightingtype
          , 
          data=modeldata)

summary(fit)
plot(fit)
crPlots(fit)
durbinWatsonTest(fit) #Multi-collinear?
vif(fit) # variance inflation factors 
sqrt(vif(fit)) > 2 # problem?
ggPredict(fit)

#perform forward stepwise regression on yn data
fiticept <- lm(Mean_pm25 ~ 1, data=modeldata)
hotstepper <- step(fiticept, direction='both', scope=formula(modeldata_yn), trace=0)
#view results of forward stepwise regression
hotstepper$anova
#view final model
summary(hotstepper)


######## Explore the continuous data and model with it
# A regression was conducted for PM2.5 exposure against the time estimates of different activities as recorded in the surveys.  Lighting type, incense, region, and working periods, and use of mosquito coils were excluded from the model as they did not  improve the explanatory power of the model.  The only significant predictor of exposure found in the model at the 5% confidence level was exposure to tobacco (1 reported exposure to tobacco was associated with 3.8 µg/m3 increase in concentration).  Cooking inside was associated with slightly lower exposure, and use of charcoal and wood stoves were both associated with elevated exposures (1.4 and 0.9 µg/m3 increase in average exposure per hour of usage), but none of these relationships were statistically significant. 
modeldata_continuous <- modeldata %>%  dplyr::select(Mean_pm25 ,tobacco_exp_freq,home_fraction,
                                                     
                                                     insidecooking,#tobacco_freq,
                                                     tobacco_exp_freq,Charcoal_stove,Cooking,Mosquito_coil,#D8_lightingtype
                                                     Errands_home,Errands_out,Incense,Kerosene_stove,  region, LPG_stove,#Mosquito_coil,       
                                                     Wood_stove,Working) %>% 
  # dplyr::mutate(Mean_pm25log = log(Mean_pm25)) %>% 
  replace(is.na(.), 0)

# scatterplots <- ggpairs(modeldata_continuous)
# print(scatterplots)

# corrplots <- ggcorr(modeldata_continuous)
# print(corrplots)

fitcont <- lm(Mean_pm25 ~ insidecooking +
                tobacco_exp_freq+Charcoal_stove+#D8_lightingtype
                Errands_home+Errands_out+
                home_fraction+
                Kerosene_stove+LPG_stove+Mosquito_coil+       #Incense
                Wood_stove,#+region # +Working,
              data=modeldata_continuous)

summary(fitcont)
plot(fitcont)

fiticept_cont <- lm(Mean_pm25 ~ 1, data=modeldata_continuous)
hotstepper_cont <- step(fiticept_cont, direction='both', scope=formula(modeldata_continuous), trace=0)
summary(hotstepper_cont)


###### Model by activity
# We ran a regression model between exposure to PM2.5 and activity information that was collected by surveys at the end of the sampling period.  These data associate the concentrations during the specific periods of time as recalled by the participants, with the activities they were engaged in during those times.  The intercept in this regression represents the activities categorized as time spent at home doing various activities (excluding cooking)  and the intercept concentration is 41.6µg/m3.  The use of wood, charcoal, and kerosene stoves were associated with significant and substantial increases in exposure relative to no cooking (91.1, 58.0, and 23.5µg/m3), while cooking with LPG was associated with only a 12.3 µg/m3 increase (p = 0.11).  The cooking category was from survey responses in which the participant reported cooking
fit_activity <- lm(Mean_pm25 ~ activity_clean,
                   data=summary_by_activity %>% dplyr::filter(sampletype == "personal"))
summary(fit_activity)
plot(fit_activity)

# A linear regression model was performed to quantify the relationship between modes of transportation and the PM2.5 concentrations during those events.Transportation modes were checked against GPS data to ensure the speeds were physically reasonable, and times provided by the participants were adjusted per the GPS data, as needed.
fit_transportation <- lm(Mean_pm25 ~ transportation,
                         data=summary_by_transport)
summary(fit_transportation)
plot(fit_transportation)

```


# Activity and transport plots (no PA data, this is just the time segments.)
```{r activity_plots}

#Plot time activity data and transportation data
#Import updated transport and activities.  Merge them?
plot_transport_fun <- function(data_selected){
  
  tt_plot <- data_selected %>% 
    ggplot() +  
    # geom_segment(aes(y=activity, yend=activity, x=min(startTime),
    #                  xend=max(endTime)), color="#b2b2b2", size=0.15) %>% 
    geom_dumbbell(aes(y=description, x=datetime_start_mod, xend=datetime_end_mod),
                  size=1.5, color="#b2b2b2", size_x=3, size_xend = 3)+
    ggtitle(data_selected$hhid[1])
  # geom_segment(aes(y=startTime, yend=endTime, x=0, xend=.5), color="#b2b2b2", size=0.15)
  print(tt_plot)
}

as.data.frame(odkend_transport_processed_mm) %>%
  dplyr::group_by(hhid) %>%
  dplyr::do(f=plot_transport_fun(.))


#Plot each deployment's raw data
while (!is.null(dev.list()))  dev.off()

as.data.frame(all_merged) %>%
  dplyr::group_by(hhid) %>%
  dplyr::do(f=plot_pa_with_activities(.,odkend_transport_processed_mm,odkend_time_activities))

```


# Save data
```{r save_data}

#Write summary stats to an excel workbook
list_of_datasets <- list("Deployment Summary" = summary_pa_deployment,
                         "Overall Summary" = summary_overall,
                         "summary_by_activity" = summary_by_activity,
                         "summary_by_transport" = summary_by_transport)
openxlsx::write.xlsx(list_of_datasets, file = paste0("../results/Summary Statistics ",format(now(),"%d-%b-%y"),".xlsx"))


saveRDS(all_merged,file="Results/processed data/all_merged.RDS")
write.xlsx(all_merged,file="Results/processed data/all_merged.xlsx")

list_of_datasets <- list(
  "PurpleAir and GPS"=summary_pa_deployment,
  "summary_overall" = summary_overall
)

filename = paste0("QA Reports/QA_PA_GPS_ODK_",Sys.Date(),".xlsx")

write.xlsx(list_of_datasets,file = filename)

# source('r_scripts/emailfun.R')
# emailfun(email,filename)

```
